
# 无线局域网 (Wi-Fi)

在小程序中支持搜索周边的 Wi-Fi 设备，同时可以针对指定设备，传入密码发起连接。[微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.startWifi.html)

# 小程序提供三种使用wifi能力的流程【[文档连接](https://developers.weixin.qq.com/miniprogram/dev/framework/device/wifi.html)】

* 在实际配网中，如果没有特殊的配网流程，我们只需要关注好 初始化wifi[[startWifi](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.startWifi.html)]->  获取wifi列表[[getWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.getWifiList.html)] -> 获取到wifi列表数据事件[[onGetWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.onGetWifiList.html)]
* 根据以上动作获取到wifi数据后就可以根据不同业务要求去增加对应流程
* 在实际配网中，因为使用的设备不一样，不同系统获取wifi的条件也不同，需要考虑好对应不同设备的流程
* Android 系统 6.0 以上版本，在没有打开定位开关的时候会导致设备不能正常获取周边的 Wi-Fi 信息。
* Ios 系统，请求获取周边 Wi-Fi 列表接口[[getWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.getWifiList.html)]会跳转到系统设置中的微信设置页，需引导用户进入「无线局域网」设置页，手动连接设备

## 1. 连接指定 Wi-Fi 设备

如果知道 Wi-Fi 设备名称和密码，并确认设备在附近，可以直接在小程序中连接指定 Wi-Fi。

接口调用时序为：

1. [startWifi](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.startWifi.html): 初始化 Wi-Fi 模块
2. [connectWifi](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.connectWifi.html): 连接 Wi-Fi（iOS 需 11 及以上版本支持）
3. [onWifiConnected](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.onWifiConnected.html): 连接上 Wi-Fi 的事件回调

## 2. 连接周边 Wi-Fi 设备

小程序可以通过扫描附近的 Wi-Fi 设备，让用户选择某个设备进行连接。

由于系统限制，不同平台下接口调用时序有所差异：

**Android**

1. [startWifi](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.startWifi.html): 初始化 Wi-Fi 模块
2. [getWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.getWifiList.html): 请求获取周边 Wi-Fi 列表
3. [onGetWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.onGetWifiList.html): 获取到 Wi-Fi 列表数据事件
4. [connectWifi](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.connectWifi.html): 连接 Wi-Fi
5. [onWifiConnected](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.onWifiConnected.html): 连接上 Wi-Fi 的事件回调

**iOS**

1. [startWifi](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.startWifi.html): 初始化 Wi-Fi 模块
2. [getWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.getWifiList.html): 请求获取周边 Wi-Fi 列表。本接口会跳转到系统设置中的微信设置页，需引导用户进入「无线局域网」设置页，手动连接设备。（iOS 11.0 及 11.1 版本因系统问题失效）
3. [onGetWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.onGetWifiList.html): 获取到 Wi-Fi 列表数据事件
4. [setWifiList](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.setWifiList.html): 设置 Wi-Fi 列表 中 AP 的相关信息，辅助用户进行连接
5. [onWifiConnected](https://developers.weixin.qq.com/miniprogram/dev/api/device/wifi/wx.onWifiConnected.html): 连接上 Wi-Fi 的事件回调

# 代码参考

```typescript
// distributionNetwork.ts
import Dialog from '../../miniprogram_npm/@vant/weapp/dialog/dialog'
import { WifiInfoData } from '@ts/types/distributionNetworkTypes'

interface PageData {
  wifiList: WifiInfoData[]
}
Page({
  data: {
    wifiList: [], // wifi列表
} as PageData,
  onLoad(): void {
    this.startWifi()
  },
  /** ============
   * = 初始化 Wi-Fi
  ============ */
  startWifi(): void {
    wx.startWifi({
      success: (): void => {
        if (['ios', 'mac'].includes(wx.getSystemInfoSync().platform)) {
          Dialog.confirm({
            title: '获取手机 Wi-Fi 列表',
            message: 'IOS系统获取 Wi-Fi 列表，需要用户手动进入「无线局域网」设置页，并在系统扫描到设备后返回小程序才可获得 Wi-Fi 数据',
          }).then((): void => {
            this.getWifiList()
          })
        } else {
          this.getWifiList()
        }
      },
    })
  },
  /** ============
   * = 请求wifi列表
  ============ */
  getWifiList(): void {
    wx.getWifiList({
      success: (): void => this.onGetWifiList(),
    })
  },
  /** ============
   * = 获取wifi列表
  ============ */
  onGetWifiList(): void {
    wx.onGetWifiList(({ wifiList: list }: WechatMiniprogram.OnGetWifiListListenerResult): void => {
      let wifiList: WifiInfoData[] = list.reduce((prev: WifiInfoData[], { SSID, BSSID, frequency }: WechatMiniprogram.WifiInfo): WifiInfoData[] => {
        if (SSID?.trim().length > 0 && BSSID?.trim().length > 0) {
          prev.push({ text: SSID, ssid: SSID, bssid: BSSID, frequency })
        }
        return prev
      }, [])
      this.setData({ wifiList })
    })
  },
})

```
